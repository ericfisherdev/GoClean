<!DOCTYPE html>
<html lang="en" class="{{ themeClass .Config.Theme }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoClean Code Analysis Report</title>
    {{ .RefreshMeta }}
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <style>
        .dark-theme {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .dark-theme .card {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }
        
        .dark-theme .list-group-item {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }
        
        .dark-theme .table {
            color: #e0e0e0;
        }
        
        .dark-theme .table-striped > tbody > tr:nth-of-type(odd) > td,
        .dark-theme .table-striped > tbody > tr:nth-of-type(odd) > th {
            background-color: #2d2d2d;
        }
        
        .violation-card {
            transition: transform 0.2s ease-in-out;
        }
        
        .violation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .file-tree {
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .file-tree-item {
            padding: 0.25rem 0;
            border-left: 1px solid #e0e0e0;
            margin-left: 1rem;
            padding-left: 1rem;
        }
        
        .code-snippet {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.85em;
        }
        
        .keyword {
            color: #0066cc;
            font-weight: bold;
        }
        
        .dark-theme .keyword {
            color: #66ccff;
        }
        
        .stats-card {
            border-left: 4px solid;
        }
        
        .stats-card.critical {
            border-left-color: #dc3545;
        }
        
        .stats-card.high {
            border-left-color: #fd7e14;
        }
        
        .stats-card.medium {
            border-left-color: #ffc107;
        }
        
        .stats-card.low {
            border-left-color: #198754;
        }
        
        .progress-stacked {
            height: 8px;
        }
        
        .auto-refresh-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        
        .fade-in {
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .filtered-hidden {
            display: none !important;
        }
        
        .search-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .dark-theme .search-highlight {
            background-color: #664d03;
            color: #fff;
        }
        
        .file-item.no-visible-violations .accordion-button {
            opacity: 0.5;
        }
        
        .filter-active {
            border-left: 3px solid #007bff !important;
        }
        
        .sort-indicator {
            margin-left: 5px;
            font-size: 0.8em;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Auto-refresh indicator -->
    {{ if .Config.AutoRefresh }}
    <div class="auto-refresh-indicator">
        <div class="badge bg-info">
            <i class="bi bi-arrow-clockwise"></i> Auto-refresh every {{ .Config.RefreshInterval }}s
        </div>
    </div>
    {{ end }}

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-code-square"></i> GoClean Report</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">Generated: {{ .GeneratedAt }}</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4 fade-in">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card critical">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="card-title text-danger mb-1">{{ .Summary.TotalViolations }}</h3>
                                <p class="card-text small text-muted mb-0">Total Violations</p>
                            </div>
                            <i class="bi bi-exclamation-triangle-fill text-danger fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="card-title text-primary mb-1">{{ .Summary.ScannedFiles }}</h3>
                                <p class="card-text small text-muted mb-0">Files Scanned</p>
                            </div>
                            <i class="bi bi-file-earmark-code-fill text-primary fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="card-title text-success mb-1">{{ formatDuration .Summary.Duration }}</h3>
                                <p class="card-text small text-muted mb-0">Scan Duration</p>
                            </div>
                            <i class="bi bi-clock-fill text-success fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="card-title text-info mb-1">{{ .Summary.TotalFiles }}</h3>
                                <p class="card-text small text-muted mb-0">Total Files</p>
                            </div>
                            <i class="bi bi-folder-fill text-info fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Violations by Type Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-pie-chart-fill"></i> Violations by Type</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="violationsByTypeChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Violations by Severity Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-bar-chart-fill"></i> Violations by Severity</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="violationsBySeverityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Violated Files -->
        {{ if .Statistics.TopViolatedFiles }}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-file-earmark-x-fill"></i> Most Violated Files</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>File</th>
                                        <th>Total Violations</th>
                                        <th>Lines</th>
                                        <th>Violations per 100 Lines</th>
                                        <th>Severity Distribution</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{ range .Statistics.TopViolatedFiles }}
                                    <tr>
                                        <td>
                                            <code><a href="#file-{{ replace .File "/" "_" }}" class="text-decoration-none">{{ basename .File }}</a></code>
                                            <br><small class="text-muted">{{ dirname .File }}</small>
                                        </td>
                                        <td><span class="badge bg-danger">{{ .TotalViolations }}</span></td>
                                        <td>{{ .Lines }}</td>
                                        <td>{{ percentage .TotalViolations .Lines | printf "%.1f" }}%</td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                {{ range $severity, $count := .ViolationsBySeverity }}
                                                {{ if gt $count 0 }}
                                                <span class="{{ severityBadge $severity }}">{{ $count }}</span>
                                                {{ end }}
                                                {{ end }}
                                            </div>
                                        </td>
                                    </tr>
                                    {{ end }}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{ end }}

        <!-- Filter and Search Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-funnel"></i> Filters & Search</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="searchInput" class="form-label">Search Files & Violations</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search in files, messages, code...">
                                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="severityFilter" class="form-label">Severity</label>
                                <select class="form-select" id="severityFilter">
                                    <option value="">All Severities</option>
                                    <option value="Critical">Critical</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="typeFilter" class="form-label">Violation Type</label>
                                <select class="form-select" id="typeFilter">
                                    <option value="">All Types</option>
                                    <option value="function_length">Long Functions</option>
                                    <option value="function_complexity">Complex Functions</option>
                                    <option value="function_parameters">Too Many Parameters</option>
                                    <option value="naming_convention">Naming Convention</option>
                                    <option value="code_duplication">Code Duplication</option>
                                    <option value="missing_documentation">Missing Documentation</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="sortBy" class="form-label">Sort By</label>
                                <select class="form-select" id="sortBy">
                                    <option value="file">File Name</option>
                                    <option value="severity">Severity</option>
                                    <option value="type">Violation Type</option>
                                    <option value="line">Line Number</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="expandAll">
                                        <i class="bi bi-arrows-expand"></i> Expand All
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="collapseAll">
                                        <i class="bi bi-arrows-collapse"></i> Collapse All
                                    </button>
                                </div>
                                <div class="ms-3 d-inline-block">
                                    <small class="text-muted">
                                        <span id="visibleFilesCount">0</span> files visible, 
                                        <span id="visibleViolationsCount">0</span> violations shown
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Details -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list-ul"></i> Detailed Violations</h5>
                    </div>
                    <div class="card-body">
                        {{ $violationsByFile := .GetViolationsByFile }}
                        {{ if $violationsByFile }}
                        <div class="accordion" id="fileAccordion">
                            {{ range $filePath, $violations := $violationsByFile }}
                            <div class="accordion-item file-item" 
                                 id="file-{{ replace $filePath "/" "_" }}"
                                 data-file-path="{{ $filePath }}"
                                 data-file-name="{{ basename $filePath }}"
                                 data-violation-count="{{ len $violations }}"
                                 data-search-content="{{ $filePath | lower }}">
                                <h2 class="accordion-header" id="heading-{{ replace $filePath "/" "_" }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapse-{{ replace $filePath "/" "_" }}" 
                                            aria-expanded="false" aria-controls="collapse-{{ replace $filePath "/" "_" }}">
                                        <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                            <div>
                                                <strong>{{ basename $filePath }}</strong>
                                                <br><small class="text-muted">{{ $filePath }}</small>
                                            </div>
                                            <div class="d-flex gap-2 align-items-center">
                                                <span class="badge bg-danger violation-count-badge">{{ len $violations }} violations</span>
                                            </div>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse-{{ replace $filePath "/" "_" }}" 
                                     class="accordion-collapse collapse" 
                                     aria-labelledby="heading-{{ replace $filePath "/" "_" }}" 
                                     data-bs-parent="#fileAccordion">
                                    <div class="accordion-body">
                                        {{ range $violations }}
                                        <div class="card violation-card mb-3"
                                             data-severity="{{ .Severity }}"
                                             data-type="{{ .Type }}"
                                             data-line="{{ .Line }}"
                                             data-search-content="{{ .Message | lower }} {{ .Description | lower }} {{ .CodeSnippet | lower }}">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h6 class="card-title mb-1">
                                                            <i class="bi bi-{{ severityIcon .Severity }}"></i>
                                                            {{ violationTypeDisplay .Type }}
                                                        </h6>
                                                        <span class="{{ severityBadge .Severity }}">{{ .Severity }}</span>
                                                    </div>
                                                    <small class="text-muted">Line {{ .Line }}{{ if .EndLine }}-{{ .EndLine }}{{ end }}</small>
                                                </div>
                                                
                                                <p class="card-text">{{ .Message }}</p>
                                                
                                                {{ if .Description }}
                                                <p class="card-text"><small class="text-muted">{{ .Description }}</small></p>
                                                {{ end }}
                                                
                                                {{ if .CodeSnippet }}
                                                <div class="mt-3">
                                                    <h6>Code:</h6>
                                                    <pre class="code-snippet border rounded p-2"><code class="language-go">{{ .CodeSnippet }}</code></pre>
                                                </div>
                                                {{ end }}
                                                
                                                {{ if .Suggestion }}
                                                <div class="alert alert-info mt-3 mb-0">
                                                    <i class="bi bi-lightbulb-fill"></i> <strong>Suggestion:</strong> {{ .Suggestion }}
                                                </div>
                                                {{ end }}
                                            </div>
                                        </div>
                                        {{ end }}
                                    </div>
                                </div>
                            </div>
                            {{ end }}
                        </div>
                        <div id="noResultsMessage" class="alert alert-warning mt-3" style="display: none;">
                            <i class="bi bi-exclamation-triangle-fill"></i> No violations match the current filters.
                        </div>
                        {{ else }}
                        <div class="alert alert-success" role="alert">
                            <i class="bi bi-check-circle-fill"></i> No violations found! Your code follows clean code principles.
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Violations by Type Chart
        const violationsByTypeCtx = document.getElementById('violationsByTypeChart').getContext('2d');
        const violationsByTypeData = {
            {{ $violationsByType := .Statistics.ViolationsByType }}
            labels: [
                {{ range $type, $count := $violationsByType }}
                "{{ violationTypeDisplay $type }}",
                {{ end }}
            ],
            datasets: [{
                data: [
                    {{ range $type, $count := $violationsByType }}
                    {{ $count }},
                    {{ end }}
                ],
                backgroundColor: [
                    '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997',
                    '#0dcaf0', '#6f42c1', '#d63384', '#6c757d', '#495057'
                ],
                borderWidth: 2
            }]
        };
        
        new Chart(violationsByTypeCtx, {
            type: 'doughnut',
            data: violationsByTypeData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Violations by Severity Chart
        const violationsBySeverityCtx = document.getElementById('violationsBySeverityChart').getContext('2d');
        const violationsBySeverityData = {
            {{ $violationsBySeverity := .Statistics.ViolationsBySeverity }}
            labels: [
                {{ range $severity, $count := $violationsBySeverity }}
                "{{ $severity }}",
                {{ end }}
            ],
            datasets: [{
                data: [
                    {{ range $severity, $count := $violationsBySeverity }}
                    {{ $count }},
                    {{ end }}
                ],
                backgroundColor: [
                    '#198754', '#ffc107', '#fd7e14', '#dc3545'
                ],
                borderWidth: 2
            }]
        };
        
        new Chart(violationsBySeverityCtx, {
            type: 'bar',
            data: violationsBySeverityData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
        
        // Auto-scroll to first violation when file is opened
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            button.addEventListener('click', function() {
                setTimeout(() => {
                    if (this.getAttribute('aria-expanded') === 'true') {
                        this.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 150);
            });
        });
        
        // Add fade-in animation to cards on load
        window.addEventListener('load', function() {
            document.querySelectorAll('.card, .accordion-item').forEach((element, index) => {
                setTimeout(() => {
                    element.classList.add('fade-in');
                }, index * 50);
            });
        });
        
        // Interactive filtering and sorting functionality
        class ViolationFilter {
            constructor() {
                this.fileItems = document.querySelectorAll('.file-item');
                this.violationCards = document.querySelectorAll('.violation-card');
                this.searchInput = document.getElementById('searchInput');
                this.severityFilter = document.getElementById('severityFilter');
                this.typeFilter = document.getElementById('typeFilter');
                this.sortBy = document.getElementById('sortBy');
                this.clearSearchBtn = document.getElementById('clearSearch');
                this.expandAllBtn = document.getElementById('expandAll');
                this.collapseAllBtn = document.getElementById('collapseAll');
                this.visibleFilesCount = document.getElementById('visibleFilesCount');
                this.visibleViolationsCount = document.getElementById('visibleViolationsCount');
                this.noResultsMessage = document.getElementById('noResultsMessage');
                
                this.initEventListeners();
                this.updateCounts();
            }

            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }

            escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            initEventListeners() {
                const debouncedFilter = this.debounce(() => this.applyFilters(), 250);

                // Search input
                this.searchInput.addEventListener('input', debouncedFilter);
                this.clearSearchBtn.addEventListener('click', () => {
                    this.searchInput.value = '';
                    this.applyFilters();
                });
                
                // Filter dropdowns
                this.severityFilter.addEventListener('change', () => this.applyFilters());
                this.typeFilter.addEventListener('change', () => this.applyFilters());
                
                // Sort dropdown
                this.sortBy.addEventListener('change', () => this.applySorting());
                
                // Expand/Collapse buttons
                this.expandAllBtn.addEventListener('click', () => this.expandAll());
                this.collapseAllBtn.addEventListener('click', () => this.collapseAll());
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'f':
                                e.preventDefault();
                                this.searchInput.focus();
                                break;
                            case 'e':
                                e.preventDefault();
                                this.expandAll();
                                break;
                            case 'c':
                                e.preventDefault();
                                this.collapseAll();
                                break;
                        }
                    }
                    if (e.key === 'Escape') {
                        this.searchInput.value = '';
                        this.applyFilters();
                    }
                });
            }
            
            applyFilters() {
                const searchTerm = this.searchInput.value.toLowerCase().trim();
                const severityFilter = this.severityFilter.value;
                const typeFilter = this.typeFilter.value;
                
                let visibleFiles = 0;
                let visibleViolations = 0;
                
                this.fileItems.forEach(fileItem => {
                    const fileName = fileItem.dataset.fileName.toLowerCase();
                    const filePath = fileItem.dataset.filePath.toLowerCase();
                    const fileSearchContent = fileItem.dataset.searchContent;
                    
                    // Check if file matches search
                    const fileMatches = !searchTerm || 
                        fileName.includes(searchTerm) || 
                        filePath.includes(searchTerm) || 
                        fileSearchContent.includes(searchTerm);
                    
                    // Filter violations within this file
                    const violations = fileItem.querySelectorAll('.violation-card');
                    let visibleViolationsInFile = 0;
                    
                    violations.forEach(violation => {
                        const severity = violation.dataset.severity;
                        const type = violation.dataset.type;
                        const searchContent = violation.dataset.searchContent;
                        
                        const severityMatches = !severityFilter || severity === severityFilter;
                        const typeMatches = !typeFilter || type === typeFilter;
                        const contentMatches = !searchTerm || searchContent.includes(searchTerm);
                        
                        const violationVisible = severityMatches && typeMatches && contentMatches;
                        
                        if (violationVisible) {
                            violation.classList.remove('filtered-hidden');
                            visibleViolationsInFile++;
                        } else {
                            violation.classList.add('filtered-hidden');
                        }
                    });
                    
                    // Show/hide file based on whether it has visible violations and matches search
                    const fileVisible = fileMatches && visibleViolationsInFile > 0;
                    
                    if (fileVisible) {
                        fileItem.classList.remove('filtered-hidden');
                        fileItem.classList.remove('no-visible-violations');
                        visibleFiles++;
                        visibleViolations += visibleViolationsInFile;
                        
                        // Update violation count badge
                        const badge = fileItem.querySelector('.violation-count-badge');
                        if (badge) {
                            badge.textContent = `${visibleViolationsInFile} violations`;
                        }
                    } else {
                        fileItem.classList.add('filtered-hidden');
                        if (visibleViolationsInFile === 0 && violations.length > 0) {
                            fileItem.classList.add('no-visible-violations');
                        }
                    }
                });
                
                this.updateCounts(visibleFiles, visibleViolations);
                this.highlightSearchTerms(searchTerm);
            }
            
            applySorting() {
                const sortBy = this.sortBy.value;
                const accordion = document.getElementById('fileAccordion');
                const fileItems = Array.from(this.fileItems);
                
                fileItems.sort((a, b) => {
                    switch (sortBy) {
                        case 'file':
                            return a.dataset.fileName.localeCompare(b.dataset.fileName);
                        case 'severity':
                            // Sort by highest severity first
                            const severityOrder = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
                            const aMaxSeverity = Math.max(...Array.from(a.querySelectorAll('.violation-card:not(.filtered-hidden)')).map(v => severityOrder[v.dataset.severity] || 0));
                            const bMaxSeverity = Math.max(...Array.from(b.querySelectorAll('.violation-card:not(.filtered-hidden)')).map(v => severityOrder[v.dataset.severity] || 0));
                            return bMaxSeverity - aMaxSeverity;
                        case 'type':
                            const aTypes = Array.from(a.querySelectorAll('.violation-card:not(.filtered-hidden)')).map(v => v.dataset.type).sort().join('');
                            const bTypes = Array.from(b.querySelectorAll('.violation-card:not(.filtered-hidden)')).map(v => v.dataset.type).sort().join('');
                            return aTypes.localeCompare(bTypes);
                        case 'line':
                            const aMinLine = Math.min(...Array.from(a.querySelectorAll('.violation-card:not(.filtered-hidden)')).map(v => parseInt(v.dataset.line) || Infinity));
                            const bMinLine = Math.min(...Array.from(b.querySelectorAll('.violation-card:not(.filtered-hidden)')).map(v => parseInt(v.dataset.line) || Infinity));
                            return aMinLine - bMinLine;
                        default:
                            return 0;
                    }
                });
                
                // Reorder DOM elements
                fileItems.forEach(item => accordion.appendChild(item));
            }
            
            expandAll() {
                const collapses = document.querySelectorAll('#fileAccordion .accordion-collapse:not(.filtered-hidden)');
                collapses.forEach(collapse => {
                    if (!collapse.closest('.file-item').classList.contains('filtered-hidden')) {
                        const bsCollapse = new bootstrap.Collapse(collapse, { show: true });
                    }
                });
            }
            
            collapseAll() {
                const collapses = document.querySelectorAll('#fileAccordion .accordion-collapse.show');
                collapses.forEach(collapse => {
                    const bsCollapse = bootstrap.Collapse.getInstance(collapse);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                });
            }
            
            highlightSearchTerms(searchTerm) {
                // Remove existing highlights
                document.querySelectorAll('.search-highlight').forEach(highlight => {
                    const parent = highlight.parentNode;
                    parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
                    parent.normalize();
                });
                
                if (!searchTerm) return;

                const escapedSearchTerm = this.escapeRegExp(searchTerm);
                
                // Add new highlights
                const walker = document.createTreeWalker(
                    document.getElementById('fileAccordion'),
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                const textNodes = [];
                let node;
                while (node = walker.nextNode()) {
                    if (node.parentElement.tagName !== 'SCRIPT' && 
                        node.parentElement.tagName !== 'STYLE' &&
                        !node.parentElement.classList.contains('search-highlight')) {
                        textNodes.push(node);
                    }
                }
                
                textNodes.forEach(textNode => {
                    const text = textNode.textContent;
                    const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
                    if (regex.test(text)) {
                        const span = document.createElement('span');
                        span.innerHTML = text.replace(regex, '<span class="search-highlight">$1</span>');
                        textNode.parentNode.replaceChild(span, textNode);
                    }
                });
            }
            
            updateCounts(visibleFiles = null, visibleViolations = null) {
                if (visibleFiles === null) {
                    visibleFiles = document.querySelectorAll('.file-item:not(.filtered-hidden)').length;
                }
                if (visibleViolations === null) {
                    visibleViolations = document.querySelectorAll('.violation-card:not(.filtered-hidden)').length;
                }
                
                this.visibleFilesCount.textContent = visibleFiles;
                this.visibleViolationsCount.textContent = visibleViolations;

                const hasActiveFilter = this.searchInput.value || this.severityFilter.value || this.typeFilter.value;
                if (this.noResultsMessage) {
                    this.noResultsMessage.style.display = (visibleFiles === 0 && hasActiveFilter) ? 'block' : 'none';
                }
            }
        }
        
        // Initialize filter when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('fileAccordion')) {
                new ViolationFilter();
            }
        });
    </script>
</body>
</html>